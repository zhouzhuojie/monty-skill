#!/bin/bash
# Monty - Run Python code safely in a secure sandbox
# Usage: ./monty "python_code" [OPTIONS]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FUNCTIONS_FILE="${SCRIPT_DIR}/functions.py"
TIMEOUT=30

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            echo "Usage: ./monty \"python_code\" [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  -f, --functions FILE    External functions file (default: ./functions.py)"
            echo "  -t, --timeout SECONDS   Timeout (default: 30)"
            echo ""
            echo "Examples:"
            echo '  ./monty "print(2 + 2)"'
            echo '  ./monty "result = await fetch(...)" -f functions.py'
            exit 0
            ;;
        -f|--functions)
            FUNCTIONS_FILE="$2"
            shift 2
            ;;
        -t|--timeout)
            TIMEOUT="$2"
            shift 2
            ;;
        *)
            CODE="$1"
            shift
            ;;
    esac
done

if [[ -z "$CODE" ]]; then
    echo "Error: Python code required"
    echo "Usage: ./monty \"python_code\""
    exit 1
fi

# Find Python interpreter
if [[ -f "${SCRIPT_DIR}/.venv/bin/python" ]]; then
    PYTHON="${SCRIPT_DIR}/.venv/bin/python"
else
    PYTHON="python3"
fi

# Check monty installation
if ! "$PYTHON" -c "import pydantic_monty" 2>/dev/null; then
    echo "Error: pydantic-monty not installed"
    echo "Install: uv add pydantic-monty"
    exit 1
fi

# Create temp files
TEMP_SCRIPT=$(mktemp /tmp/monty_XXXXXX.py)
TEMP_CODE=$(mktemp /tmp/monty_code_XXXXXX.py)
trap "rm -f $TEMP_SCRIPT $TEMP_CODE" EXIT

echo "$CODE" > "$TEMP_CODE"

cat > "$TEMP_SCRIPT" << 'PYTHON'
import asyncio
import sys
from pathlib import Path
import pydantic_monty

code_file = "CODE_FILE"
functions_file = "FUNCTIONS_FILE"

with open(code_file) as f:
    code = f.read().strip()

functions_code = ""
if Path(functions_file).exists():
    with open(functions_file) as f:
        functions_code = f.read()

# Find function calls in code
import re
fn_names = set()
for m in re.findall(r'\b([a-zA-Z_][a-zA-Z0-9_]*)\s*\(', code):
    if m not in ['print', 'len', 'str', 'int', 'float', 'bool', 'list', 'dict',
                 'set', 'tuple', 'range', 'enumerate', 'zip', 'map', 'filter',
                 'sorted', 'reversed', 'type', 'isinstance', 'hasattr',
                 'getattr', 'setattr', 'delattr', 'break', 'continue', 'pass',
                 'return', 'yield', 'raise', 'try', 'except', 'finally',
                 'async', 'await', 'if', 'else', 'elif', 'for', 'while',
                 'def', 'class', 'import', 'from', 'as', 'assert', 'del',
                 'global', 'nonlocal', 'lambda', 'or', 'and', 'not', 'in',
                 'True', 'False', 'None', 'self', 'super', '__import__']:
        fn_names.add(m)

# Load external functions
fns = {}
if fn_names and functions_code:
    ns = {}
    exec(compile(functions_code, '<functions>', 'exec'), ns)
    for name in fn_names:
        if name in ns and callable(ns[name]):
            fns[name] = ns[name]

async def run():
    try:
        m = pydantic_monty.Monty(
            code, inputs=[],
            external_functions=list(fns.keys()) if fns else [],
            script_name='sandbox.py', type_check=False,
            type_check_stubs=functions_code
        )
        result = await pydantic_monty.run_monty_async(m, external_functions=fns) if fns \
                 else await pydantic_monty.run_monty_async(m)
        if result and hasattr(result, 'output'):
            print(result.output)
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)

asyncio.run(run())
PYTHON

# Replace placeholders
"$PYTHON" - "$TEMP_SCRIPT" "$TEMP_CODE" "$FUNCTIONS_FILE" << 'PYEOF'
import sys
fp, cf, ff = sys.argv[1], sys.argv[2], sys.argv[3]
with open(fp) as f:
    c = f.read().replace('CODE_FILE', cf).replace('FUNCTIONS_FILE', ff)
with open(fp, 'w') as f:
    f.write(c)
PYEOF

# Run
if command -v timeout &>/dev/null; then
    timeout "$TIMEOUT" "$PYTHON" "$TEMP_SCRIPT"
else
    "$PYTHON" "$TEMP_SCRIPT"
fi
